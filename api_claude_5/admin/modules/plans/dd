<?php
$plans = $db->query("SELECT * FROM " . DB_PREFIX . "plans ORDER BY tokens_per_month ASC");

// Procesar formulario
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    $action = $_POST['action'];
    
    if ($action === 'create' || $action === 'edit') {
        $data = [
            'name' => $_POST['name'],
            'tokens_per_month' => (int)$_POST['tokens_per_month'],
            'billing_cycle' => $_POST['billing_cycle'],
            'woo_product_id' => !empty($_POST['woo_product_id']) ? (int)$_POST['woo_product_id'] : null,
            'is_active' => 1
        ];
        
        if ($action === 'create') {
            $data['id'] = $_POST['plan_id'];
            $data['created_at'] = date('Y-m-d H:i:s');
            $db->insert('plans', $data);
        } else {
            $db->update('plans', $data, 'id = ?', [$_POST['plan_id']]);
        }
        
        header('Location: ?module=plans');
        exit;
    }
    
    if ($action === 'delete') {
        $db->delete('plans', 'id = ?', [$_POST['plan_id']]);
        header('Location: ?module=plans');
        exit;
    }
    
    if ($action === 'toggle') {
        $newStatus = $_POST['is_active'];
        $db->update('plans', ['is_active' => $newStatus], 'id = ?', [$_POST['plan_id']]);
        header('Location: ?module=plans');
        exit;
    }
}

// Modo edición
$editing = isset($_GET['edit']) ? $_GET['edit'] : null;
$editPlan = null;
if ($editing) {
    $editPlan = $db->fetchOne("SELECT * FROM " . DB_PREFIX . "plans WHERE id = ?", [$editing]);
}

$creating = isset($_GET['create']);
?>

<style>
.plans-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
.plan-card { background: white; border-radius: 8px; padding: 24px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
.plan-card h3 { margin: 0 0 10px; color: #2c3e50; }
.plan-card .tokens { font-size: 24px; font-weight: 700; color: #3498db; margin: 10px 0; }
.plan-card .status { position: absolute; top: 10px; right: 10px; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
.status.active { background: #d4edda; color: #155724; }
.status.inactive { background: #e2e3e5; color: #383d41; }
.plan-actions { margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
.btn { padding: 8px 16px; border-radius: 4px; border: none; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; }
.btn-primary { background: #007bff; color: white; }
.btn-warning { background: #ffc107; color: #212529; }
.btn-success { background: #28a745; color: white; }
.btn-danger { background: #dc3545; color: white; }
.form-card { background: white; padding: 30px; border-radius: 8px; margin-bottom: 20px; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
.form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
.header-actions { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
</style>

<div class="header-actions">
    <h2>Gestión de Planes</h2>
    <?php if (!$creating && !$editing): ?>
        <a href="?module=plans&create=1" class="btn btn-primary">+ Nuevo Plan</a>
    <?php endif; ?>
</div>

<?php if ($creating || $editing): ?>
    <div class="form-card">
        <h3><?= $editing ? 'Editar Plan' : 'Crear Nuevo Plan' ?></h3>
        <form method="POST">
            <input type="hidden" name="action" value="<?= $editing ? 'edit' : 'create' ?>">
            
            <div class="form-group">
                <label>ID del Plan *</label>
                <input type="text" name="plan_id" value="<?= $editPlan['id'] ?? '' ?>" 
                       <?= $editing ? 'readonly' : '' ?> required 
                       placeholder="basic, pro, enterprise">
                <small>Solo letras minúsculas, sin espacios</small>
            </div>
            
            <div class="form-group">
                <label>Nombre *</label>
                <input type="text" name="name" value="<?= $editPlan['name'] ?? '' ?>" required>
            </div>
            
            <div class="form-group">
                <label>Tokens por mes *</label>
                <input type="number" name="tokens_per_month" value="<?= $editPlan['tokens_per_month'] ?? '' ?>" required>
            </div>
            
            <div class="form-group">
                <label>Ciclo de facturación *</label>
                <select name="billing_cycle" required>
                    <option value="monthly" <?= ($editPlan['billing_cycle'] ?? '') === 'monthly' ? 'selected' : '' ?>>Mensual</option>
                    <option value="yearly" <?= ($editPlan['billing_cycle'] ?? '') === 'yearly' ? 'selected' : '' ?>>Anual</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>WooCommerce Product ID</label>
                <input type="number" name="woo_product_id" value="<?= $editPlan['woo_product_id'] ?? '' ?>">
                <small>Opcional - ID del producto en WooCommerce</small>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-primary">Guardar</button>
                <a href="?module=plans" class="btn">Cancelar</a>
            </div>
        </form>
    </div>
<?php else: ?>
    <div class="plans-grid">
        <?php foreach ($plans as $plan): ?>
            <div class="plan-card">
                <span class="status <?= $plan['is_active'] ? 'active' : 'inactive' ?>">
                    <?= $plan['is_active'] ? 'Activo' : 'Inactivo' ?>
                </span>
                
                <h3><?= htmlspecialchars($plan['name']) ?></h3>
                <div class="tokens"><?= number_format($plan['tokens_per_month']) ?> tokens</div>
                <div style="color: #7f8c8d; font-size: 14px;">Ciclo: <?= $plan['billing_cycle'] ?></div>
                
                <?php if (!empty($plan['woo_product_id'])): ?>
                    <div style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                        WooCommerce ID: <?= $plan['woo_product_id'] ?>
                    </div>
                <?php endif; ?>
                
                <div class="plan-actions">
                    <a href="?module=plans&edit=<?= $plan['id'] ?>" class="btn btn-warning">Editar</a>
                    
                    <form method="POST" style="display: inline;" onsubmit="return confirm('¿Cambiar estado?')">
                        <input type="hidden" name="action" value="toggle">
                        <input type="hidden" name="plan_id" value="<?= $plan['id'] ?>">
                        <input type="hidden" name="is_active" value="<?= $plan['is_active'] ? 0 : 1 ?>">
                        <button type="submit" class="btn <?= $plan['is_active'] ? 'btn-danger' : 'btn-success' ?>">
                            <?= $plan['is_active'] ? 'Desactivar' : 'Activar' ?>
                        </button>
                    </form>
                    
                    <form method="POST" style="display: inline;" onsubmit="return confirm('¿ELIMINAR este plan? Esta acción no se puede deshacer.')">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="plan_id" value="<?= $plan['id'] ?>">
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                    </form>
                </div>
            </div>
        <?php endforeach; ?>
    </div>
<?php endif; ?>
